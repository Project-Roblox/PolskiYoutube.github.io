<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Shorts</title>
    <style>
        body { margin: 0; background: black; color: white; overflow: hidden; font-family: sans-serif; }
        .shorts-container { height: 100vh; overflow-y: scroll; scroll-snap-type: y mandatory; }
        .short-item { height: 100vh; width: 100%; position: relative; scroll-snap-align: start; display: flex; justify-content: center; background: #000; }
        
        video { height: 100%; width: 100%; object-fit: contain; } /* Dopasowanie jak w apce */

        /* Prawy pasek interakcji */
        .actions { position: absolute; right: 10px; bottom: 100px; display: flex; flex-direction: column; gap: 20px; align-items: center; z-index: 10; }
        .act-btn { background: rgba(0,0,0,0.4); border-radius: 50%; width: 45px; height: 45px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; border: none; color: white; font-size: 20px; }
        .act-label { font-size: 11px; margin-top: 5px; font-weight: bold; }

        .overlay { position: absolute; bottom: 20px; left: 10px; width: 70%; z-index: 10; text-shadow: 1px 1px 2px black; pointer-events: none; }
        .back-btn { position: absolute; top: 20px; left: 20px; z-index: 20; background: rgba(0,0,0,0.5); border: none; color: white; padding: 10px; border-radius: 50%; cursor: pointer; }

        /* Komentarze Modal */
        .comments-modal { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background: #1a1a1a; border-radius: 20px 20px 0 0; z-index: 100; transform: translateY(100%); transition: 0.3s; display: flex; flex-direction: column; }
        .comments-modal.show { transform: translateY(0); }
        .c-header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        .c-list { flex: 1; overflow-y: auto; padding: 10px; font-size: 13px; }
        .c-input { display: flex; padding: 10px; border-top: 1px solid #333; }
    </style>
</head>
<body>

<button class="back-btn" onclick="location.href='index.html'">‚¨Ö</button>
<div class="shorts-container" id="container"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, where, updateDoc, doc, arrayUnion, addDoc, onSnapshot, increment, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyCpp-nUIT7bHmtO8qJI3-Q89biIpsnIBzM", authDomain: "polski-youtub2.firebaseapp.com", projectId: "polski-youtub2", storageBucket: "polski-youtub2.firebasestorage.app", messagingSenderId: "325129789226", appId: "1:325129789226:web:f68f2f1a1f8f9feaf14853", measurementId: "G-B5M3F5J713" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // 1. ≈ÅADOWANIE SHORTS√ìW
    async function loadShorts() {
        const q = query(collection(db, "content"), where("type", "==", "short"));
        const snap = await getDocs(q);
        const container = document.getElementById('container');

        snap.forEach(d => {
            const data = d.data();
            const div = document.createElement('div');
            div.className = 'short-item';
            div.id = `vid-${d.id}`;
            div.innerHTML = `
                <video src="${data.url}" loop muted playsinline></video>
                
                <div class="overlay">
                    <h3 style="margin:0">${data.title}</h3>
                    <p style="margin:5px 0">@${data.author}</p>
                </div>

                <div class="actions">
                    <div onclick="like('${d.id}')" style="text-align:center">
                        <button class="act-btn">‚ù§Ô∏è</button>
                        <span class="act-label" id="l-count-${d.id}">${data.likes || 0}</span>
                    </div>
                    <div onclick="toggleComments('${d.id}')" style="text-align:center">
                        <button class="act-btn">üí¨</button>
                        <span class="act-label">Koment.</span>
                    </div>
                    <div onclick="subscribe('${data.author}')" style="text-align:center">
                        <button class="act-btn" style="background: red;">+</button>
                        <span class="act-label">Sub</span>
                    </div>
                </div>

                <div class="comments-modal" id="c-modal-${d.id}">
                    <div class="c-header">
                        <span>Komentarze</span>
                        <span style="cursor:pointer" onclick="toggleComments('${d.id}')">‚úñ</span>
                    </div>
                    <div class="c-list" id="c-list-${d.id}">≈Åadowanie...</div>
                    <div class="c-input">
                        <input type="text" id="c-inp-${d.id}" style="flex:1; background:#333; border:none; color:white; padding:8px; border-radius:4px;" placeholder="Dodaj komentarz...">
                        <button onclick="sendComment('${d.id}')" style="background:#3ea6ff; border:none; color:black; font-weight:bold; margin-left:5px; border-radius:4px;">></button>
                    </div>
                </div>
            `;
            container.appendChild(div);
        });

        startObserver();
    }

    // 2. AUTO-ODTWARZANIE (OBSERVER)
    function startObserver() {
        const videos = document.querySelectorAll('video');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                // Je≈õli film widoczny w 60% -> GRAJ
                if (entry.isIntersecting) {
                    entry.target.currentTime = 0;
                    entry.target.play().catch(e => console.log("Autoplay blocked, click needed"));
                    entry.target.muted = false; // Pr√≥ba odmutowania
                } else {
                    entry.target.pause(); // Je≈õli wyjecha≈Ç poza ekran -> PAUZA
                }
            });
        }, { threshold: 0.6 });

        videos.forEach(v => observer.observe(v));
    }

    // 3. FUNKCJE INTERAKCJI (MuszƒÖ byƒá window.x bo module)
    window.like = async (id) => {
        if(!auth.currentUser) return alert("Zaloguj siƒô!");
        const ref = doc(db, "content", id);
        await updateDoc(ref, { likes: increment(1) });
        const el = document.getElementById(`l-count-${id}`);
        el.innerText = parseInt(el.innerText) + 1;
    };

    window.subscribe = async (authorEmail) => {
        if(!auth.currentUser) return alert("Zaloguj siƒô!");
        if(authorEmail === auth.currentUser.email) return alert("Nie mo≈ºesz subskrybowaƒá siebie!");
        
        // Dodajemy suba do kolekcji zalogowanego usera
        await setDoc(doc(db, "users", auth.currentUser.email), {
            subscriptions: arrayUnion(authorEmail)
        }, { merge: true });
        alert(`Zasubskrybowano: ${authorEmail}`);
    };

    window.toggleComments = (id) => {
        const modal = document.getElementById(`c-modal-${id}`);
        modal.classList.toggle('show');
        if(modal.classList.contains('show')) loadComments(id);
    };

    function loadComments(vidId) {
        const list = document.getElementById(`c-list-${vidId}`);
        const q = query(collection(db, `content/${vidId}/comments`), orderBy("time", "desc"));
        onSnapshot(q, (snap) => {
            list.innerHTML = "";
            snap.forEach(d => {
                const c = d.data();
                list.innerHTML += `<div style="margin-bottom:8px"><b>${c.user}:</b> ${c.text}</div>`;
            });
        });
    }

    window.sendComment = async (vidId) => {
        const txt = document.getElementById(`c-inp-${vidId}`).value;
        if(!txt || !auth.currentUser) return;
        
        await addDoc(collection(db, `content/${vidId}/comments`), {
            text: txt,
            user: auth.currentUser.email.split('@')[0],
            time: new Date()
        });
        document.getElementById(`c-inp-${vidId}`).value = "";
    };

    loadShorts();
</script>
</body>
</html>
